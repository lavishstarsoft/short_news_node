<!DOCTYPE html>
<html lang="en">

<%- include('partials/header', { title: 'Locations' }) %>

    <style>
        .location-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .location-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
            background-color: #28a745;
        }

        .location-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .location-card:hover .location-actions {
            opacity: 1;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .add-location-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .add-location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .form-control,
        .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .btn-warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 500;
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: block;
        }

        /* Mobile header icons */
        .mobile-header-icons {
            display: flex;
            gap: 10px;
        }
    </style>
    </head>

    <body>
        <%- include('partials/top-nav', { pageTitle: 'Locations Management' , backButton: true, backUrl: '/' }) %>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <%- include('partials/sidebar', { activePage: 'locations' }) %>

                        <!-- Main Content -->
                        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="mainContent">
                            <div class="content-area">
                                <!-- Stats Cards -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">Total Locations</h5>
                                                    <h2 id="totalLocations">0</h2>
                                                </div>
                                                <i class="fas fa-map-marker-alt fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">Active</h5>
                                                    <h2 id="activeLocations">0</h2>
                                                </div>
                                                <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stats-card">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h5 class="mb-1">Total News</h5>
                                                    <h2 id="totalNewsInLocations">0</h2>
                                                </div>
                                                <i class="fas fa-newspaper fa-2x opacity-75"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Header with Add Button -->
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3 class="mb-0">Locations Management</h3>
                                    <button type="button" class="btn add-location-btn ripple"
                                        onclick="openAddLocationModal()">
                                        <i class="fas fa-plus me-2"></i>Add Location
                                    </button>
                                </div>

                                <!-- Locations Grid -->
                                <div class="row" id="locationsGrid">
                                    <div class="col-12 text-center">
                                        <div class="loading">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2">Loading locations...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Add/Edit Location Modal -->
            <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="locationModalLabel">Add New Location</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="locationForm">
                                <input type="hidden" id="locationId" name="id">
                                <div class="mb-3">
                                    <label for="locationName" class="form-label">Location Name *</label>
                                    <input type="text" class="form-control" id="locationName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="locationCode" class="form-label">Location Code *</label>
                                    <input type="text" class="form-control" id="locationCode" name="code" required>
                                    <div class="form-text">Short code for the location (e.g., AP for Andhra Pradesh)
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="locationStatus" class="form-label">Status</label>
                                    <select class="form-select" id="locationStatus" name="isActive">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveLocation()">
                                <span class="loading-text">Save Location</span>
                                <span class="loading d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    Saving...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this location?</p>
                            <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                                <span class="loading-text">Delete</span>
                                <span class="loading d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    Deleting...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                let locations = [];
                let currentLocationId = null;
                let deleteLocationId = null;

                // Initialize page
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('DOM Content Loaded - Initializing locations page');
                    loadLocations();
                    setupMobileMenu();
                });

                // Load locations
                async function loadLocations() {
                    try {
                        console.log('Loading locations...');
                        const response = await fetch('/locations/api/locations');
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const data = await response.json();
                        locations = data;
                        console.log('Locations loaded:', locations);
                        renderLocations();
                        loadStats();
                    } catch (error) {
                        console.error('Error loading locations:', error);
                        document.getElementById('locationsGrid').innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                                <h4 class="text-danger">Error Loading Locations</h4>
                                <p class="text-danger">${error.message}</p>
                                <button class="btn btn-primary" onclick="loadLocations()">
                                    <i class="fas fa-sync me-2"></i>Retry
                                </button>
                            </div>
                        `;
                    }
                }

                // Load statistics
                function loadStats() {
                    console.log('loadStats called with locations:', locations);

                    // Ensure locations is an array
                    if (!Array.isArray(locations)) {
                        console.log('Locations is not an array, setting to empty array');
                        locations = [];
                    }

                    // Calculate stats directly from locations data
                    const totalLocations = locations.length;
                    const activeLocations = locations.filter(loc => loc && loc.isActive).length;
                    const totalNewsInLocations = locations.reduce((sum, loc) => sum + (loc && loc.newsCount ? loc.newsCount : 0), 0);

                    console.log('Calculated stats:', { totalLocations, activeLocations, totalNewsInLocations });

                    // Update the DOM elements
                    const totalLocationsEl = document.getElementById('totalLocations');
                    const activeLocationsEl = document.getElementById('activeLocations');
                    const totalNewsInLocationsEl = document.getElementById('totalNewsInLocations');

                    console.log('DOM elements found:', {
                        totalLocationsEl: !!totalLocationsEl,
                        activeLocationsEl: !!activeLocationsEl,
                        totalNewsInLocationsEl: !!totalNewsInLocationsEl
                    });

                    if (totalLocationsEl) {
                        totalLocationsEl.textContent = totalLocations;
                        console.log('Updated totalLocations element:', totalLocationsEl.textContent);
                    } else {
                        console.error('totalLocations element not found!');
                    }

                    if (activeLocationsEl) {
                        activeLocationsEl.textContent = activeLocations;
                        console.log('Updated activeLocations element:', activeLocationsEl.textContent);
                    } else {
                        console.error('activeLocations element not found!');
                    }

                    if (totalNewsInLocationsEl) {
                        totalNewsInLocationsEl.textContent = totalNewsInLocations;
                        console.log('Updated totalNewsInLocations element:', totalNewsInLocationsEl.textContent);
                    } else {
                        console.error('totalNewsInLocations element not found!');
                    }

                    console.log('Stats update completed');
                }

                // Render locations
                function renderLocations() {
                    const grid = document.getElementById('locationsGrid');
                    if (locations.length === 0) {
                        grid.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No locations found</h4>
                                <p class="text-muted">Create your first location to get started</p>
                                <button class="btn btn-primary" onclick="openAddLocationModal()">
                                    <i class="fas fa-plus me-2"></i>Add Location
                                </button>
                            </div>
                        `;
                        return;
                    }

                    grid.innerHTML = locations.map(location => `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card location-card h-100">
                                <div class="card-body text-center">
                                    <div class="location-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <h5 class="card-title">${location.name}</h5>
                                    <p class="card-text">
                                        <span class="badge ${location.isActive ? 'bg-success' : 'bg-secondary'} status-badge">
                                            ${location.isActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </p>
                                    <p class="card-text">
                                        <small class="text-muted">${location.newsCount || 0} News Articles</small>
                                    </p>
                                    <div class="location-actions">
                                        <button class="btn btn-sm btn-primary me-2" onclick="editLocation('${location._id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning me-2" onclick="toggleLocationStatus('${location._id}')">
                                            <i class="fas fa-${location.isActive ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteLocation('${location._id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Open add location modal
                function openAddLocationModal() {
                    currentLocationId = null;
                    document.getElementById('locationModalLabel').textContent = 'Add New Location';
                    document.getElementById('locationForm').reset();
                    document.getElementById('locationStatus').value = 'true';
                    new bootstrap.Modal(document.getElementById('locationModal')).show();
                }

                // Edit location
                function editLocation(id) {
                    // Fetch the location data from the API
                    fetch(`/locations/api/locations/${id}`)
                        .then(response => response.json())
                        .then(location => {
                            currentLocationId = id;
                            document.getElementById('locationModalLabel').textContent = 'Edit Location';
                            document.getElementById('locationId').value = location._id;
                            document.getElementById('locationName').value = location.name;
                            document.getElementById('locationCode').value = location.code;
                            document.getElementById('locationStatus').value = location.isActive.toString();
                            new bootstrap.Modal(document.getElementById('locationModal')).show();
                        })
                        .catch(error => {
                            console.error('Error fetching location:', error);
                            showAlert('Error fetching location data', 'danger');
                        });
                }

                // Save location
                async function saveLocation() {
                    const form = document.getElementById('locationForm');
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    // Convert isActive to boolean
                    data.isActive = data.isActive === 'true';

                    const saveBtn = document.querySelector('#locationModal .btn-primary');
                    const loadingText = saveBtn.querySelector('.loading-text');
                    const loading = saveBtn.querySelector('.loading');

                    try {
                        loadingText.classList.add('d-none');
                        loading.classList.remove('d-none');

                        const url = currentLocationId ? `/locations/api/locations/${currentLocationId}` : '/locations/api/locations';
                        const method = currentLocationId ? 'PUT' : 'POST';

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showAlert(currentLocationId ? 'Location updated successfully!' : 'Location created successfully!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('locationModal')).hide();
                            loadLocations();
                        } else {
                            showAlert(result.error || 'Error saving location', 'danger');
                        }
                    } catch (error) {
                        console.error('Error saving location:', error);
                        showAlert('Error saving location', 'danger');
                    } finally {
                        loadingText.classList.remove('d-none');
                        loading.classList.add('d-none');
                    }
                }

                // Toggle location status
                async function toggleLocationStatus(id) {
                    try {
                        const response = await fetch(`/locations/api/locations/${id}/toggle`, {
                            method: 'PATCH'
                        });
                        const result = await response.json();

                        if (response.ok) {
                            showAlert(result.message, 'success');
                            loadLocations();
                        } else {
                            showAlert(result.error || 'Error toggling location status', 'danger');
                        }
                    } catch (error) {
                        console.error('Error toggling location status:', error);
                        showAlert('Error toggling location status', 'danger');
                    }
                }

                // Delete location
                function deleteLocation(id) {
                    deleteLocationId = id;
                    new bootstrap.Modal(document.getElementById('deleteModal')).show();
                }

                // Confirm delete
                async function confirmDelete() {
                    if (!deleteLocationId) return;

                    const deleteBtn = document.querySelector('#deleteModal .btn-danger');
                    const loadingText = deleteBtn.querySelector('.loading-text');
                    const loading = deleteBtn.querySelector('.loading');

                    try {
                        loadingText.classList.add('d-none');
                        loading.classList.remove('d-none');

                        const response = await fetch(`/locations/api/locations/${deleteLocationId}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();

                        if (response.ok) {
                            showAlert('Location deleted successfully!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                            loadLocations();
                        } else {
                            showAlert(result.error || 'Error deleting location', 'danger');
                        }
                    } catch (error) {
                        console.error('Error deleting location:', error);
                        showAlert('Error deleting location', 'danger');
                    } finally {
                        loadingText.classList.remove('d-none');
                        loading.classList.add('d-none');
                        deleteLocationId = null;
                    }
                }

                // Show alert
                function showAlert(message, type) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
                    document.body.appendChild(alertDiv);

                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 5000);
                }

                // Mobile menu setup
                function setupMobileMenu() {
                    const menuToggle = document.getElementById('menuToggle');
                    const sidebar = document.getElementById('sidebar');
                    const mainContent = document.getElementById('mainContent');

                    if (menuToggle && sidebar) {
                        menuToggle.addEventListener('click', function (e) {
                            e.stopPropagation();
                            sidebar.classList.toggle('active');
                            mainContent.classList.toggle('sidebar-active');
                        });
                    }

                    document.addEventListener('click', function (event) {
                        if (window.innerWidth < 768 &&
                            sidebar && sidebar.classList.contains('active') &&
                            !sidebar.contains(event.target) &&
                            event.target !== menuToggle &&
                            !menuToggle.contains(event.target)) {
                            sidebar.classList.remove('active');
                            if (mainContent) {
                                mainContent.classList.remove('sidebar-active');
                            }
                        }
                    });

                    const sidebarLinks = document.querySelectorAll('.sidebar a');
                    sidebarLinks.forEach(link => {
                        link.addEventListener('click', function () {
                            if (window.innerWidth < 768 && sidebar) {
                                sidebar.classList.remove('active');
                                if (mainContent) {
                                    mainContent.classList.remove('sidebar-active');
                                }
                            }
                        });
                    });
                }
            </script>

            <%- include('partials/footer') %>
    </body>

</html>