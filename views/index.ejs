<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Short News Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .location-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .location-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .location-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin: 0 auto 15px;
            background-color: #28a745;
        }

        /* News content preview - exactly 3 lines */
        .news-content-preview {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            max-height: calc(1.4em * 3);
        }

        /* Remove padding on mobile for locations section */
        @media (max-width: 767.98px) {
            .locations-section-no-padding {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            .locations-section-no-padding .card {
                margin-left: 4px;
                margin-right: 4px;
            }
        }

        /* News card hover effect */
        .news-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        /* News detail modal */
        .news-detail-content img,
        .news-detail-content video {
            max-height: 400px;
            object-fit: cover;
        }

        /* Make action buttons not trigger card click */
        .news-card .btn {
            pointer-events: auto;
        }

        /* Mobile header icons */
        .mobile-header-icons {
            display: flex;
            gap: 10px;
        }

        /* Interaction stats card */
        .stats-card {
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Detail view styles */
        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .interaction-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .interaction-item:last-child {
            border-bottom: none;
        }

        .comment-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .comment-item:last-child {
            border-bottom: none;
        }

        /* Scrollable sections */
        .scrollable-section {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- Mobile Top Navigation - Android Material Design -->
    <div class="top-nav d-md-none">
        <button class="menu-toggle ripple" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="page-title">Dashboard</h1>
        <div class="mobile-header-icons">
            <button class="menu-toggle ripple" onclick="window.location.href='/profile'">
                <i class="fas fa-user"></i>
            </button>
            <button class="menu-toggle ripple" onclick="window.location.href='/add-news'">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Desktop Navigation -->
    <div class="top-nav d-none d-md-flex justify-content-between align-items-center">
        <h1 class="page-title mb-0">Dashboard</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary ripple" onclick="window.location.href='/profile'">
                <i class="fas fa-user me-1"></i> Profile
            </button>
            <button class="btn btn-primary ripple" onclick="window.location.href='/add-news'">
                <i class="fas fa-plus me-1"></i> Add News
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <%- include('partials/sidebar', { activePage: 'dashboard' }) %>

                <!-- Main Content -->
                <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="mainContent">
                    <div class="content-area">
                        <!-- Stats Cards -->
                        <div class="stats-container">
                            <div class="card text-white bg-primary stats-card">
                                <div class="card-body">
                                    <h5 class="card-title text-white">Total News</h5>
                                    <h2>
                                        <%= typeof totalNewsCount !=='undefined' ? totalNewsCount : (typeof newsList
                                            !=='undefined' ? newsList.length : 0) %>
                                    </h2>
                                </div>
                            </div>
                            <div class="card text-white bg-success stats-card">
                                <div class="card-body">
                                    <h5 class="card-title text-white">Active News</h5>
                                    <h2>
                                        <%= typeof activeNewsCount !=='undefined' ? activeNewsCount : (typeof newsList
                                            !=='undefined' ? newsList.filter(n=> n.isActive !== false).length : 0) %>
                                    </h2>
                                </div>
                            </div>
                            <div class="card text-white bg-secondary stats-card">
                                <div class="card-body">
                                    <h5 class="card-title text-white">Inactive News</h5>
                                    <h2>
                                        <%= typeof inactiveNewsCount !=='undefined' ? inactiveNewsCount : (typeof
                                            newsList !=='undefined' ? newsList.filter(n=> n.isActive === false).length :
                                            0) %>
                                    </h2>
                                </div>
                            </div>
                            <div class="card text-white bg-warning stats-card">
                                <div class="card-body">
                                    <h5 class="card-title text-white">Today's News</h5>
                                    <h2>
                                        <%= typeof todaysNewsCount !=='undefined' ? todaysNewsCount : 0 %>
                                    </h2>
                                </div>
                            </div>
                        </div>

                        <!-- Locations Section -->
                        <div class="row mb-4 mx-md-0 locations-section-no-padding">
                            <div class="col-12 px-0">
                                <div class="d-flex justify-content-between align-items-center mb-3 mx-2 mx-md-0">
                                    <h3 class="mb-0">Locations</h3>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="window.location.href='/locations'">
                                        <i class="fas fa-map-marker-alt"></i> Manage Locations
                                    </button>
                                </div>

                                <div class="row mx-0" id="locationsContainer">
                                    <div class="col-12 text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading locations...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- News List -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Recent News</h3>
                            <button type="button" class="btn btn-sm btn-outline-primary d-md-none ripple"
                                onclick="window.location.href='/add-news'">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>

                        <div class="row row-cols-1 row-cols-md-3 g-3">
                            <% newsList.forEach(function(news) { %>
                                <div class="col">
                                    <div class="news-card h-100" onclick="openNewsDetail('<%= news._id %>')"
                                        style="cursor: pointer; position: relative;">
                                        <div style="position: relative;">
                                            <% if (news.mediaType==='video' ) { %>
                                                <video src="<%= news.mediaUrl %>" class="card-img-top"
                                                    style="height: 200px; object-fit: cover;" controls></video>
                                                <% } else { %>
                                                    <img src="<%= news.mediaUrl || news.imageUrl %>"
                                                        class="card-img-top" alt="<%= news.title %>">
                                                    <% } %>
                                                        <% if (news.location) { %>
                                                            <div
                                                                style="position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">
                                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                                <% if (news.locationCode) { %>
                                                                    <%= news.locationCode %>
                                                                        <% } %>
                                                            </div>
                                                            <% } %>
                                                                <!-- Active status indicator -->
                                                                <div
                                                                    style="position: absolute; top: 10px; right: 10px;">
                                                                    <span
                                                                        class="badge <%= news.isActive === false ? 'bg-secondary' : 'bg-success' %>">
                                                                        <%= news.isActive===false ? 'Inactive'
                                                                            : 'Active' %>
                                                                    </span>
                                                                </div>
                                        </div>
                                        <div class="card-body">
                                            <h5 class="card-title">
                                                <%= news.title.substring(0, 30) %>
                                            </h5>
                                            <p class="card-text news-content-preview">
                                                <%= news.content.substring(0, 60) %>
                                            </p>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">
                                                    <%= news.category %>
                                                </small>
                                                <small class="text-muted">
                                                    <%= new Date(news.publishedAt).toLocaleString() %>
                                                </small>
                                            </div>
                                            <% if (typeof admin !=='undefined' && admin && admin.role !=='editor' ) { %>
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-user me-1"></i>
                                                        <%= news.author %>
                                                    </small>
                                                </div>
                                                <% } %>
                                                    <!-- Interaction counts -->
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <small class="text-muted">
                                                            <i class="fas fa-thumbs-up text-primary me-1"></i>
                                                            <%= news.likes || 0 %>
                                                        </small>
                                                        <small class="text-muted">
                                                            <i class="fas fa-thumbs-down text-danger me-1"></i>
                                                            <%= news.dislikes || 0 %>
                                                        </small>
                                                        <small class="text-muted">
                                                            <i class="fas fa-comment text-success me-1"></i>
                                                            <%= news.comments || 0 %>
                                                        </small>
                                                    </div>
                                                    <div class="d-flex gap-2 flex-nowrap">
                                                        <button
                                                            class="btn btn-sm btn-<%= news.isActive === false ? 'success' : 'secondary' %> ripple"
                                                            onclick="toggleNewsStatus('<%= news._id %>'); event.stopPropagation();">
                                                            <i
                                                                class="fas fa-<%= news.isActive === false ? 'check' : 'times' %>"></i>
                                                            <span class="d-none d-sm-inline">
                                                                <%= news.isActive===false ? 'Activate' : 'Deactivate' %>
                                                            </span>
                                                        </button>
                                                        <button class="btn btn-sm btn-primary ripple"
                                                            onclick="editNews('<%= news._id %>'); event.stopPropagation();">
                                                            <i class="fas fa-edit"></i>
                                                            <span class="d-none d-sm-inline"> Edit</span>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger ripple"
                                                            onclick="deleteNews('<%= news._id %>'); event.stopPropagation();">
                                                            <i class="fas fa-trash"></i>
                                                            <span class="d-none d-sm-inline"> Delete</span>
                                                        </button>
                                                    </div>
                                        </div>
                                    </div>
                                </div>
                                <% }); %>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- News Detail Modal -->
    <div class="modal fade" id="newsDetailModal" tabindex="-1" aria-labelledby="newsDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newsDetailModalLabel">News Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="news-detail-content">
                        <div class="row">
                            <div class="col-lg-8">
                                <div id="newsDetailMediaContainer" class="mb-3">
                                    <img id="newsDetailImage" src="" class="img-fluid rounded" alt="News Image"
                                        style="width: 100%; max-height: 400px; object-fit: cover;">
                                </div>
                                <h3 id="newsDetailTitle" class="mb-3"></h3>
                                <div class="d-flex flex-wrap gap-3 mb-3">
                                    <span id="newsDetailCategory" class="badge bg-primary"></span>
                                    <span id="newsDetailLocation" class="badge bg-success"></span>
                                    <span id="newsDetailDate" class="badge bg-secondary"></span>
                                    <span id="newsDetailStatus" class="badge bg-info"></span>
                                </div>
                                <p id="newsDetailContent" class="mb-4"></p>
                            </div>
                            <div class="col-lg-4">
                                <!-- Interaction Stats -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Interaction Stats</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-around text-center">
                                            <div>
                                                <div class="fs-4 text-primary" id="newsDetailLikes">0</div>
                                                <div class="small text-muted">Likes</div>
                                            </div>
                                            <div>
                                                <div class="fs-4 text-danger" id="newsDetailDislikes">0</div>
                                                <div class="small text-muted">Dislikes</div>
                                            </div>
                                            <div>
                                                <div class="fs-4 text-success" id="newsDetailCommentsCount">0</div>
                                                <div class="small text-muted">Comments</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Author Information -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-user-edit me-2"></i>Published By</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <div class="bg-light rounded-circle d-flex align-items-center justify-content-center"
                                                    style="width: 50px; height: 50px;">
                                                    <i class="fas fa-user fa-lg text-muted"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <h6 class="mb-0" id="newsDetailAuthor">-</h6>
                                                <small class="text-muted">Editor/Admin</small>
                                                <div class="small text-muted" id="newsDetailAuthorId"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Likes Section -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-thumbs-up text-primary me-2"></i>Likes</h6>
                                        <span class="badge bg-primary" id="likesCount">0</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="likesList" class="list-group list-group-flush"
                                            style="max-height: 200px; overflow-y: auto;">
                                            <div class="text-center p-3">
                                                <small class="text-muted">No likes yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dislikes Section -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-thumbs-down text-danger me-2"></i>Dislikes
                                        </h6>
                                        <span class="badge bg-danger" id="dislikesCount">0</span>
                                    </div>
                                    <div class="card-body p-0">
                                        <div id="dislikesList" class="list-group list-group-flush"
                                            style="max-height: 200px; overflow-y: auto;">
                                            <div class="text-center p-3">
                                                <small class="text-muted">No dislikes yet</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="card">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-comments text-success me-2"></i>Comments</h6>
                                <span class="badge bg-success" id="commentsCount">0</span>
                            </div>
                            <div class="card-body">
                                <div id="commentsList">
                                    <div class="text-center p-3">
                                        <small class="text-muted">No comments yet</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script id="newsData" type="application/json"><%- JSON.stringify(newsList) %></script>
    <script>
        // Make newsList available globally
        const newsList = JSON.parse(document.getElementById('newsData').textContent);
    </script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Add ripple effect to buttons
            addRippleEffect();

            // Load locations
            loadLocations();

            // Mobile menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    sidebar.classList.toggle('active');
                    mainContent.classList.toggle('sidebar-active');
                });
            }

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (event) {
                if (window.innerWidth < 768 &&
                    sidebar && sidebar.classList.contains('active') &&
                    !sidebar.contains(event.target) &&
                    event.target !== menuToggle &&
                    !menuToggle.contains(event.target)) {
                    sidebar.classList.remove('active');
                    if (mainContent) {
                        mainContent.classList.remove('sidebar-active');
                    }
                }
            });

            // Close sidebar when clicking on sidebar links on mobile
            const sidebarLinks = document.querySelectorAll('.sidebar a');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function () {
                    if (window.innerWidth < 768 && sidebar) {
                        sidebar.classList.remove('active');
                        if (mainContent) {
                            mainContent.classList.remove('sidebar-active');
                        }
                    }
                });
            });
        });

        // Load locations
        async function loadLocations() {
            try {
                const response = await fetch('/locations/api/locations');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const locations = await response.json();
                renderLocations(locations);
            } catch (error) {
                console.error('Error loading locations:', error);
                document.getElementById('locationsContainer').innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-danger">Error loading locations: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Render locations
        function renderLocations(locations) {
            const container = document.getElementById('locationsContainer');

            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">No locations found</p>
                        <button class="btn btn-primary" onclick="window.location.href='/locations'">
                            <i class="fas fa-plus me-2"></i>Add Location
                        </button>
                    </div>
                `;
                return;
            }

            // Show only first 4 locations
            const displayLocations = locations.slice(0, 4);

            container.innerHTML = `
                <div class="row mx-0">
                    ${displayLocations.map(location => `
                        <div class="col-6 col-md-6 col-lg-3 mb-4 px-2">
                            <div class="card location-card h-100">
                                <div class="card-body text-center">
                                    <div class="location-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <h5 class="card-title">${location.name}</h5>
                                    <p class="card-text">
                                        <span class="badge ${location.isActive ? 'bg-success' : 'bg-secondary'}">
                                            ${location.isActive ? 'Active' : 'Inactive'}
                                        </span>
                                    </p>
                                    <p class="card-text">
                                        <small class="text-muted">${location.newsCount || 0} News Articles</small>
                                    </p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Add ripple effect to elements with "ripple" class
        function addRippleEffect() {
            const rippleElements = document.querySelectorAll('.ripple');
            rippleElements.forEach(element => {
                element.addEventListener('click', function (e) {
                    // Remove any existing ripple
                    const existingRipple = this.querySelector('.ripple-effect');
                    if (existingRipple) {
                        existingRipple.remove();
                    }

                    // Create ripple
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple-effect');

                    // Position ripple
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';

                    this.appendChild(ripple);

                    // Remove ripple after animation
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        }

        // Open news detail modal
        function openNewsDetail(newsId) {
            // Find the news item in the newsList array
            const newsItem = newsList.find(news => news._id === newsId);

            if (newsItem) {
                // Populate modal with news details
                const mediaElement = document.getElementById('newsDetailImage');
                if (newsItem.mediaType === 'video') {
                    document.getElementById('newsDetailMediaContainer').innerHTML = `
                        <video id="newsDetailImage" src="${newsItem.mediaUrl}" class="img-fluid rounded" controls style="width: 100%; max-height: 400px;"></video>
                    `;
                } else {
                    document.getElementById('newsDetailMediaContainer').innerHTML = `
                        <img id="newsDetailImage" src="${newsItem.mediaUrl || newsItem.imageUrl}" class="img-fluid rounded" alt="News Image" style="width: 100%; max-height: 400px; object-fit: cover;">
                    `;
                }
                document.getElementById('newsDetailTitle').textContent = newsItem.title;
                document.getElementById('newsDetailContent').textContent = newsItem.content;
                document.getElementById('newsDetailCategory').textContent = newsItem.category;
                document.getElementById('newsDetailAuthor').textContent = newsItem.author;
                document.getElementById('newsDetailAuthorId').textContent = `ID: ${newsItem.authorId}`;
                document.getElementById('newsDetailDate').textContent = new Date(newsItem.publishedAt).toLocaleString();
                document.getElementById('newsDetailStatus').textContent = newsItem.isActive ? 'Active' : 'Inactive';
                document.getElementById('newsDetailStatus').className = `badge ${newsItem.isActive ? 'bg-success' : 'bg-secondary'}`;
                document.getElementById('newsDetailLikes').textContent = newsItem.likes || 0;
                document.getElementById('newsDetailDislikes').textContent = newsItem.dislikes || 0;
                document.getElementById('newsDetailCommentsCount').textContent = newsItem.comments || 0;

                // Show location if available
                const locationElement = document.getElementById('newsDetailLocation');
                if (newsItem.location) {
                    const locationText = newsItem.locationCode ?
                        `${newsItem.location} (${newsItem.locationCode})` :
                        newsItem.location;
                    locationElement.textContent = locationText;
                    locationElement.style.display = 'inline-block';
                } else {
                    locationElement.style.display = 'none';
                }

                // Populate likes section
                const likesList = document.getElementById('likesList');
                const likesCount = document.getElementById('likesCount');
                if (newsItem.userInteractions && newsItem.userInteractions.likes && newsItem.userInteractions.likes.length > 0) {
                    likesCount.textContent = newsItem.userInteractions.likes.length;
                    likesList.innerHTML = newsItem.userInteractions.likes.map(like => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${like.userName}</strong>
                                    <div class="small text-muted">${like.userEmail || ''}</div>
                                </div>
                                <small class="text-muted">${new Date(like.timestamp).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    likesCount.textContent = '0';
                    likesList.innerHTML = '<div class="text-center p-3"><small class="text-muted">No likes yet</small></div>';
                }

                // Populate dislikes section
                const dislikesList = document.getElementById('dislikesList');
                const dislikesCount = document.getElementById('dislikesCount');
                if (newsItem.userInteractions && newsItem.userInteractions.dislikes && newsItem.userInteractions.dislikes.length > 0) {
                    dislikesCount.textContent = newsItem.userInteractions.dislikes.length;
                    dislikesList.innerHTML = newsItem.userInteractions.dislikes.map(dislike => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${dislike.userName}</strong>
                                    <div class="small text-muted">${dislike.userEmail || ''}</div>
                                </div>
                                <small class="text-muted">${new Date(dislike.timestamp).toLocaleDateString()}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    dislikesCount.textContent = '0';
                    dislikesList.innerHTML = '<div class="text-center p-3"><small class="text-muted">No dislikes yet</small></div>';
                }

                // Populate comments section
                const commentsList = document.getElementById('commentsList');
                const commentsCount = document.getElementById('commentsCount');
                if (newsItem.userInteractions && newsItem.userInteractions.comments && newsItem.userInteractions.comments.length > 0) {
                    commentsCount.textContent = newsItem.userInteractions.comments.length;
                    commentsList.innerHTML = newsItem.userInteractions.comments.map(comment => `
                        <div class="border-bottom pb-3 mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <strong>${comment.userName}</strong>
                                    <div class="small text-muted">${comment.userEmail || ''}</div>
                                </div>
                                <small class="text-muted">${new Date(comment.timestamp).toLocaleDateString()}</small>
                            </div>
                            <p class="mb-0">${comment.comment}</p>
                        </div>
                    `).join('');
                } else {
                    commentsCount.textContent = '0';
                    commentsList.innerHTML = '<div class="text-center p-3"><small class="text-muted">No comments yet</small></div>';
                }

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('newsDetailModal'));
                modal.show();
            }
        }

        // Edit news function
        function editNews(newsId) {
            // Redirect to edit page
            window.location.href = `/edit-news/${newsId}`;
        }

        // Delete news function
        function deleteNews(newsId) {
            if (confirm('Are you sure you want to delete this news article?')) {
                // Make API call to delete the news
                fetch(`/news/api/news/${newsId}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (response.ok) {
                            // Reload the page to reflect the changes
                            location.reload();
                        } else {
                            // Try to get error message from response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || 'Failed to delete news article');
                            }).catch(() => {
                                throw new Error('Failed to delete news article');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + error.message);
                    });
            }
        }

        // Toggle news active status function
        function toggleNewsStatus(newsId) {
            console.log('Toggle news status called with ID:', newsId); // Debug log

            // Find the news item in the newsList array
            const newsItem = newsList.find(news => news._id === newsId);

            if (newsItem) {
                console.log('Found news item:', newsItem); // Debug log

                // Make API call to toggle the news status
                fetch(`/news/api/news/${newsId}/toggle-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        isActive: !newsItem.isActive
                    })
                })
                    .then(async response => {
                        console.log('Toggle API response:', response.status, response.statusText); // Debug log

                        if (response.ok) {
                            console.log('Toggle successful, reloading page'); // Debug log
                            // Reload the page to reflect the changes
                            location.reload();
                        } else {
                            const errorData = await response.json().catch(() => ({}));
                            const errorMessage = errorData.error || 'Failed to toggle news status';
                            alert('Error: ' + errorMessage);
                            console.error('Toggle error response:', response.status, errorData);
                        }
                    })
                    .catch(error => {
                        console.error('Network error:', error);
                        alert('Network error occurred while toggling the news status: ' + error.message);
                    });
            } else {
                console.error('News item not found for ID:', newsId); // Debug log
                alert('News item not found');
            }
        }
    </script>

    <!-- Global Admin Notifications -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/admin-notifications.js"></script>
</body>

</html>