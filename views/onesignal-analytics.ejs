<%- include('partials/header', { title: 'OneSignal Analytics - Short News Admin' }) %>
    </head>

    <body>
        <%- include('partials/top-nav', { pageTitle: 'OneSignal Analytics' , backButton: true, backUrl: '/' , actions:
            [] }) %>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <% if (typeof admin !=='undefined' ) { %>
                        <%- include('partials/sidebar', { activePage: 'onesignal-analytics' }) %>
                            <% } %>

                                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                                    <div
                                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                        <h1 class="h2">OneSignal Analytics</h1>
                                    </div>

                                    <!-- OneSignal Analytics Content -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">OneSignal Analytics Data</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div id="onesignal-analytics-content">
                                                        <p>Loading OneSignal analytics data...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Image Modal -->
                                    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Notification Image</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body text-center">
                                                    <img id="modalImage" src="" alt="Notification Image"
                                                        style="max-width: 100%; height: auto;" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </main>
                </div>
            </div>

            <%- include('partials/footer') %>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        setupMobileMenu();
                        loadOneSignalAnalytics();
                        setInterval(loadOneSignalAnalytics, 60000);
                    });

                    async function loadOneSignalAnalytics() {
                        try {
                            const response = await fetch('/admin/api/onesignal/analytics');
                            const data = await response.json();

                            if (response.ok) {
                                const analyticsContainer = document.getElementById('onesignal-analytics-content');
                                if (analyticsContainer) {
                                    if (data.appDetails || (data.recentNotifications && data.recentNotifications.notifications)) {
                                        let html = '';
                                        if (data.appDetails) {
                                            html += `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>App Information</h6>
                                            <p><strong>Name:</strong> ${data.appDetails.name || 'N/A'}</p>
                                            <p><strong>ID:</strong> ${data.appDetails.id || 'N/A'}</p>
                                        </div>
                                    </div>
                                `;
                                        }

                                        if (data.recentNotifications && data.recentNotifications.notifications) {
                                            html += `
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <h6>Recent OneSignal Notifications</h6>
                                            <div class="table-responsive">
                                                <table class="table table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Title</th>
                                                            <th>Message</th>
                                                            <th>Image</th>
                                                            <th>Successful</th>
                                                            <th>Failed</th>
                                                            <th>Converted</th>
                                                            <th>Remaining</th>
                                                            <th>Date</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                `;

                                            data.recentNotifications.notifications.forEach(notification => {
                                                let dateValue = 'N/A';
                                                if (notification.sent_time) dateValue = new Date(notification.sent_time * 1000).toLocaleString();
                                                else if (notification.created_at) dateValue = new Date(notification.created_at).toLocaleString();
                                                else if (notification.send_after) dateValue = new Date(notification.send_after).toLocaleString();
                                                else if (notification.completed_at) dateValue = new Date(notification.completed_at).toLocaleString();

                                                const imageUrl = notification.big_picture || (notification.ios_attachments && Object.values(notification.ios_attachments)[0]) || null;

                                                html += `
                                        <tr>
                                            <td>${notification.headings ? notification.headings.en : 'N/A'}</td>
                                            <td>${notification.contents ? notification.contents.en : 'N/A'}</td>
                                            <td>${imageUrl ? `<img src="${imageUrl}" alt="Notification Image" style="max-width: 100px; max-height: 100px; cursor: pointer;" onclick="showImageModal('${imageUrl}')" />` : 'No Image'}</td>
                                            <td>${notification.successful || 0}</td>
                                            <td>${notification.failed || 0}</td>
                                            <td>${notification.converted || 0}</td>
                                            <td>${notification.remaining || 0}</td>
                                            <td>${dateValue}</td>
                                        </tr>
                                    `;
                                            });

                                            html += `</tbody>`;
                                            if (data.recentNotifications.total_count !== undefined) {
                                                html += `<tfoot><tr><td><strong>Total Notifications</strong></td><td colspan="7"><strong>${data.recentNotifications.total_count}</strong></td></tr></tfoot>`;
                                            }
                                            html += `</table></div></div></div>`;
                                        }
                                        analyticsContainer.innerHTML = html;
                                    } else {
                                        analyticsContainer.innerHTML = '<p>No OneSignal analytics data available.</p>';
                                    }
                                }
                            } else {
                                document.getElementById('onesignal-analytics-content').innerHTML = '<p>Error loading OneSignal analytics data.</p>';
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            document.getElementById('onesignal-analytics-content').innerHTML = '<p>Error loading OneSignal analytics data.</p>';
                        }
                    }

                    window.showImageModal = function (imageUrl) {
                        const modalImage = document.getElementById('modalImage');
                        modalImage.src = imageUrl;
                        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                        modal.show();
                    };

                    function setupMobileMenu() {
                        const menuToggle = document.getElementById('menuToggle');
                        const sidebar = document.getElementById('sidebar');
                        const mainContent = document.querySelector('main');
                        if (menuToggle && sidebar) {
                            menuToggle.addEventListener('click', function (e) {
                                e.stopPropagation();
                                sidebar.classList.toggle('active');
                                if (mainContent) mainContent.classList.toggle('sidebar-active');
                            });
                        }
                        document.addEventListener('click', function (event) {
                            if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('active') && !sidebar.contains(event.target) && event.target !== menuToggle) {
                                sidebar.classList.remove('active');
                                if (mainContent) mainContent.classList.remove('sidebar-active');
                            }
                        });
                    }
                </script>
    </body>

    </html>
    </body>

    </html>