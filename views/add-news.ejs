<!DOCTYPE html>
<html lang="en">

<%- include('partials/header', { title: (typeof news !=='undefined' ? 'Edit News' : 'Add News' ) + ' - Short News Admin'
    }) %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        /* Video thumbnail selection */
        .thumbnail-option {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .thumbnail-option:hover {
            border-color: #007bff;
        }

        .thumbnail-option.selected {
            border-color: #007bff;
            box-shadow: 0 0 0 2px #007bff;
        }

        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .thumbnail-img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
    </head>

    <body>
        <%- include('partials/top-nav', { pageTitle: typeof news !=='undefined' ? 'Edit News' : 'Add News' , backButton:
            true, backUrl: '/' , actions: [ { id: 'saveNewsButtonDesktop' , icon: 'fas fa-save' , text: (typeof news
            !=='undefined' ? 'Update News' : 'Save News' ), class: 'btn-primary' } ] }) %>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <%- include('partials/sidebar', { activePage: 'add-news' }) %>

                        <!-- Main Content -->
                        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="mainContent">
                            <div class="content-area">
                                <div class="row justify-content-center">
                                    <div class="col-lg-8">
                                        <div class="card">
                                            <div class="card-body">
                                                <h3 class="card-title mb-4">
                                                    <%= typeof news !=='undefined' ? 'Edit News Article'
                                                        : 'Create New News Article' %>
                                                </h3>
                                                <form id="addNewsForm">
                                                    <input type="hidden" id="newsId"
                                                        value="<%= typeof news !== 'undefined' ? news._id : '' %>">
                                                    <div class="mb-3">
                                                        <label for="title" class="form-label">Title</label>
                                                        <input type="text" class="form-control" id="title"
                                                            placeholder="Enter news title"
                                                            value="<%= typeof news !== 'undefined' ? news.title : '' %>"
                                                            required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="content" class="form-label">Content</label>
                                                        <textarea class="form-control" id="content" rows="6"
                                                            placeholder="Enter news content"
                                                            required><%= typeof news !== 'undefined' ? news.content : '' %></textarea>
                                                    </div>

                                                    <!-- Media Upload Section -->
                                                    <div class="mb-3">
                                                        <label class="form-label">News Media (Image or Video)</label>
                                                        <div class="border rounded p-3 mb-3">
                                                            <div class="d-flex flex-column align-items-center">
                                                                <div id="mediaPreviewContainer" class="mb-3"
                                                                    style="width: 100%; max-width: 300px;">
                                                                    <img id="imagePreview"
                                                                        src="<%= typeof news !== 'undefined' ? (news.mediaUrl || news.imageUrl) : '/images/placeholder.png' %>"
                                                                        onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2UwZTBlMCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNmZmZmZmYiPkltYWdlIFVwbG9hZDwvdGV4dD48L3N2Zz4='"
                                                                        class="img-fluid rounded" alt="Media Preview"
                                                                        style="display: block;">
                                                                    <video id="videoPreview" src="" controls
                                                                        class="img-fluid rounded" alt="Video Preview"
                                                                        style="display: none; max-height: 300px;"></video>
                                                                </div>
                                                                <button type="button"
                                                                    class="btn btn-outline-primary ripple"
                                                                    id="uploadMediaButton">
                                                                    <i class="fas fa-upload me-1"></i> Upload Media
                                                                </button>
                                                                <input type="file" id="mediaUpload"
                                                                    accept="image/*,video/*" class="d-none">
                                                                <input type="hidden" id="mediaUrl"
                                                                    value="<%= typeof news !== 'undefined' ? (news.mediaUrl || news.imageUrl) : '' %>">
                                                                <input type="hidden" id="mediaType"
                                                                    value="<%= typeof news !== 'undefined' ? (news.mediaType || 'image') : '' %>">
                                                                <input type="hidden" id="thumbnailUrl"
                                                                    value="<%= typeof news !== 'undefined' ? (news.thumbnailUrl || news.mediaUrl || news.imageUrl) : '' %>">
                                                            </div>

                                                            <!-- Video Thumbnail Selection (hidden by default) -->
                                                            <div id="thumbnailSelection" class="mt-3"
                                                                style="display: none;">
                                                                <label class="form-label">Select Thumbnail</label>
                                                                <div class="thumbnail-grid" id="thumbnailGrid">
                                                                    <!-- Thumbnails will be populated here -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="category" class="form-label">Category</label>
                                                        <select class="form-control" id="category" required>
                                                            <option value="">Loading categories...</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="location" class="form-label">Location</label>
                                                        <select class="form-control" id="location">
                                                            <option value="">Loading locations...</option>
                                                        </select>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="readFullLink" class="form-label">Read Full Article
                                                            Link
                                                            (Optional)</label>
                                                        <input type="url" class="form-control" id="readFullLink"
                                                            placeholder="https://example.com/full-article"
                                                            value="<%= typeof news !== 'undefined' ? (news.readFullLink || '') : '' %>">
                                                        <small class="form-text text-muted">Leave empty to use default
                                                            link</small>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label for="ePaperLink" class="form-label">ePaper Link
                                                            (Optional)</label>
                                                        <input type="url" class="form-control" id="ePaperLink"
                                                            placeholder="https://epaper.example.com"
                                                            value="<%= typeof news !== 'undefined' ? (news.ePaperLink || '') : '' %>">
                                                        <small class="form-text text-muted">Leave empty to use default
                                                            link</small>
                                                    </div>

                                                    <div class="d-grid gap-2 d-md-none">
                                                        <button type="button" class="btn btn-primary ripple"
                                                            id="saveNewsButtonMobile">
                                                            <i class="fas fa-save me-1"></i>
                                                            <%= typeof news !=='undefined' ? 'Update News' : 'Save News'
                                                                %>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary ripple"
                                                            onclick="window.location.href='/'">
                                                            <i class="fas fa-times me-1"></i> Cancel
                                                        </button>
                                                    </div>
                                                    <div class="d-none d-md-flex justify-content-end gap-2 mt-4">
                                                        <button type="button" class="btn btn-secondary ripple"
                                                            onclick="window.location.href='/'">
                                                            <i class="fas fa-times me-1"></i> Cancel
                                                        </button>
                                                        <button type="button" class="btn btn-primary ripple"
                                                            id="saveNewsButton">
                                                            <i class="fas fa-save me-1"></i>
                                                            <%= typeof news !=='undefined' ? 'Update News' : 'Save News'
                                                                %>
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Image Cropping Modal -->
            <div class="modal fade" id="imageCropModal" tabindex="-1" aria-labelledby="imageCropModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="imageCropModalLabel">Crop Image to 9:13 (Flutter Display)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="img-container">
                                <img id="imageToCrop" src="" alt="Image to crop">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="cropButton">Crop & Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <%- include('partials/footer') %>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
                <script>
                    // Add News Function
                    async function saveNews() {
                        const newsId = document.getElementById('newsId').value;
                        const title = document.getElementById('title').value;
                        const content = document.getElementById('content').value;
                        const mediaUrl = document.getElementById('mediaUrl').value;
                        const mediaType = document.getElementById('mediaType').value;
                        const thumbnailUrl = document.getElementById('thumbnailUrl').value;
                        const category = document.getElementById('category').value;
                        const location = document.getElementById('location').value;

                        // Validation
                        if (!title || !content || !mediaUrl || !category) {
                            showFeedback('Please fill in all required fields', 'error');
                            return;
                        }

                        const newsData = {
                            title,
                            content,
                            mediaUrl,
                            mediaType,
                            thumbnailUrl,
                            category
                        };

                        if (location) {
                            newsData.location = location;
                        }

                        const readFullLink = document.getElementById('readFullLink').value;
                        const ePaperLink = document.getElementById('ePaperLink').value;
                        if (readFullLink) {
                            newsData.readFullLink = readFullLink;
                        }
                        if (ePaperLink) {
                            newsData.ePaperLink = ePaperLink;
                        }

                        try {
                            let response;
                            if (newsId) {
                                response = await fetch(`/news/api/news/${newsId}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(newsData)
                                });
                            } else {
                                response = await fetch('/news/api/news', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(newsData)
                                });
                            }

                            if (response.ok) {
                                const successMessage = newsId ? 'News updated successfully!' : 'News added successfully!';
                                showFeedback(successMessage, 'success');

                                setTimeout(() => {
                                    window.location.href = '/news-list';
                                }, 1500);
                            } else {
                                const errorText = await response.text();
                                try {
                                    const error = JSON.parse(errorText);
                                    showFeedback('Error saving news: ' + error.error, 'error');
                                } catch (e) {
                                    showFeedback('Error saving news: ' + errorText, 'error');
                                }
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            showFeedback('Error saving news: ' + error.message, 'error');
                        }
                    }

                    // Wait for DOM to be fully loaded
                    document.addEventListener('DOMContentLoaded', function () {
                        // Load categories and locations
                        loadCategories();
                        loadLocations();

                        // Set up event listeners for save buttons
                        const saveBtnIds = ['saveNewsButton', 'saveNewsButtonMobile', 'saveNewsButtonDesktop', 'saveNewsBtn'];
                        saveBtnIds.forEach(id => {
                            const btn = document.getElementById(id);
                            if (btn) btn.addEventListener('click', saveNews);
                        });

                        // Initial media preview
                        const mediaType = document.getElementById('mediaType').value;
                        const mediaUrl = document.getElementById('mediaUrl').value;
                        if (mediaType === 'video' && mediaUrl) {
                            document.getElementById('imagePreview').style.display = 'none';
                            document.getElementById('videoPreview').src = mediaUrl;
                            document.getElementById('videoPreview').style.display = 'block';
                        }

                        // Media upload selection
                        const mediaUpload = document.getElementById('mediaUpload');
                        const uploadMediaButton = document.getElementById('uploadMediaButton');

                        if (uploadMediaButton) {
                            uploadMediaButton.addEventListener('click', () => mediaUpload.click());
                        }

                        if (mediaUpload) {
                            mediaUpload.addEventListener('change', function (e) {
                                const file = e.target.files[0];
                                if (file) {
                                    if (file.type.startsWith('video/')) {
                                        uploadMediaFile(file);
                                    } else {
                                        const reader = new FileReader();
                                        reader.onload = function (event) {
                                            const imageToCrop = document.getElementById('imageToCrop');
                                            const imageCropModalElement = document.getElementById('imageCropModal');
                                            const imageCropModal = new bootstrap.Modal(imageCropModalElement);
                                            imageToCrop.src = event.target.result;
                                            setTimeout(() => imageCropModal.show(), 100);
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                }
                            });
                        }

                        // Cropper setup
                        const imageToCrop = document.getElementById('imageToCrop');
                        const imageCropModalElement = document.getElementById('imageCropModal');
                        let cropper;

                        if (imageCropModalElement) {
                            imageCropModalElement.addEventListener('shown.bs.modal', function () {
                                if (cropper) cropper.destroy();
                                cropper = new Cropper(imageToCrop, {
                                    aspectRatio: 9 / 13,
                                    viewMode: 1,
                                    autoCropArea: 1
                                });
                            });

                            imageCropModalElement.addEventListener('hidden.bs.modal', function () {
                                if (cropper) {
                                    cropper.destroy();
                                    cropper = null;
                                }
                                imageToCrop.src = '';
                            });

                            document.getElementById('cropButton').addEventListener('click', function () {
                                if (cropper) {
                                    const canvas = cropper.getCroppedCanvas({ width: 600, height: 866 });
                                    canvas.toBlob(blob => uploadMediaFile(blob, 'image'), 'image/jpeg', 0.85);
                                }
                            });
                        }

                        setupMobileMenu();
                    });

                    // Upload media file
                    async function uploadMediaFile(file, type = null) {
                        const formData = new FormData();
                        formData.append('media', file);

                        try {
                            const response = await fetch('/news/upload-media', {
                                method: 'POST',
                                body: formData
                            });

                            if (!response.ok) throw new Error('Upload failed');

                            const data = await response.json();
                            console.log('Upload response:', data);
                            const imagePreview = document.getElementById('imagePreview');
                            const videoPreview = document.getElementById('videoPreview');
                            const mediaUrlInput = document.getElementById('mediaUrl');
                            const mediaTypeInput = document.getElementById('mediaType');
                            const thumbnailUrlInput = document.getElementById('thumbnailUrl');
                            const thumbnailSelection = document.getElementById('thumbnailSelection');

                            if (data.fileType === 'video' || type === 'video') {
                                imagePreview.style.display = 'none';
                                videoPreview.src = data.mediaUrl;
                                videoPreview.style.display = 'block';
                                mediaTypeInput.value = 'video';
                                thumbnailSelection.style.display = 'block';
                                generateVideoThumbnails(data.mediaUrl, data.thumbnailUrl);
                            } else {
                                videoPreview.style.display = 'none';
                                imagePreview.src = data.mediaUrl;
                                imagePreview.style.display = 'block';
                                mediaTypeInput.value = 'image';
                                thumbnailSelection.style.display = 'none';
                            }

                            mediaUrlInput.value = data.mediaUrl;
                            thumbnailUrlInput.value = data.thumbnailUrl || data.mediaUrl;
                            showFeedback('Media uploaded successfully!', 'success');

                            const cropBtn = document.getElementById('cropButton');
                            if (cropBtn) cropBtn.blur();

                            const modal = bootstrap.Modal.getInstance(document.getElementById('imageCropModal'));
                            if (modal) modal.hide();
                        } catch (error) {
                            console.error('Upload error:', error);
                            showFeedback('Error uploading media: ' + error.message, 'error');
                        }
                    }

                    // Generate video thumbnails
                    function generateVideoThumbnails(videoUrl, defaultThumbnail) {
                        const thumbnailGrid = document.getElementById('thumbnailGrid');
                        const thumbnailUrlInput = document.getElementById('thumbnailUrl');
                        thumbnailGrid.innerHTML = '';

                        const createThumb = (src, label, isSelected) => {
                            const div = document.createElement('div');
                            div.className = `thumbnail-option ${isSelected ? 'selected' : ''}`;
                            div.innerHTML = `<img src="${src}" class="thumbnail-img"><small class="text-center d-block mt-1">${label}</small>`;
                            div.addEventListener('click', () => {
                                document.querySelectorAll('.thumbnail-option').forEach(el => el.classList.remove('selected'));
                                div.classList.add('selected');
                                thumbnailUrlInput.value = src;
                            });
                            return div;
                        };

                        thumbnailGrid.appendChild(createThumb(defaultThumbnail, 'Default', true));
                        for (let i = 1; i <= 3; i++) {
                            thumbnailGrid.appendChild(createThumb(`https://via.placeholder.com/160x120/007bff/ffffff?text=Frame+${i}`, `Frame ${i}`, false));
                        }
                    }

                    // Load categories
                    async function loadCategories() {
                        try {
                            const response = await fetch('/categories/api/categories');
                            const categories = await response.json();
                            const select = document.getElementById('category');
                            select.innerHTML = '<option value="">Select Category</option>';
                            categories.filter(c => c.isActive).forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c.name;
                                opt.textContent = c.name;
                                select.appendChild(opt);
                            });
                            const current = '<%= typeof news !== "undefined" ? news.category : "" %>';
                            if (current) select.value = current;
                        } catch (e) { console.error(e); }
                    }

                    // Load locations
                    async function loadLocations() {
                        try {
                            const response = await fetch('/locations/api/locations');
                            const locations = await response.json();
                            const select = document.getElementById('location');
                            select.innerHTML = '<option value="">Select Location (Optional)</option>';
                            locations.filter(l => l.isActive).forEach(l => {
                                const opt = document.createElement('option');
                                opt.value = l.name;
                                opt.textContent = l.name;
                                select.appendChild(opt);
                            });
                            const current = '<%= typeof news !== "undefined" ? news.location : "" %>';
                            if (current) select.value = current;
                        } catch (e) { console.error(e); }
                    }

                    // Mobile menu setup
                    function setupMobileMenu() {
                        const menuToggle = document.getElementById('menuToggle');
                        const sidebar = document.getElementById('sidebar');
                        const mainContent = document.getElementById('mainContent');

                        if (menuToggle && sidebar) {
                            menuToggle.addEventListener('click', function (e) {
                                e.stopPropagation();
                                sidebar.classList.toggle('active');
                                mainContent.classList.toggle('sidebar-active');
                            });
                        }

                        document.addEventListener('click', function (event) {
                            if (window.innerWidth < 768 &&
                                sidebar && sidebar.classList.contains('active') &&
                                !sidebar.contains(event.target) &&
                                event.target !== menuToggle &&
                                !menuToggle.contains(event.target)) {
                                sidebar.classList.remove('active');
                                if (mainContent) mainContent.classList.remove('sidebar-active');
                            }
                        });
                    }

                    // Show feedback (Android-like snackbar)
                    function showFeedback(message, type) {
                        const existing = document.getElementById('feedback-toast');
                        if (existing) existing.remove();

                        const toast = document.createElement('div');
                        toast.id = 'feedback-toast';
                        toast.textContent = message;
                        Object.assign(toast.style, {
                            position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
                            padding: '12px 24px', borderRadius: '4px', color: 'white', zIndex: '9999',
                            backgroundColor: type === 'success' ? '#4CAF50' : (type === 'error' ? '#F44336' : '#2196F3'),
                            transition: 'all 0.3s'
                        });

                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    }
                </script>
    </body>

</html>
</body>

</html>