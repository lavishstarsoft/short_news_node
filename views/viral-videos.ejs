<!DOCTYPE html>
<html lang="en">

<%- include('partials/header', { title: 'Viral Videos - Short News Admin' }) %>
    <style>
        .video-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            margin-bottom: 20px;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .video-preview {
            width: 100%;
            height: 300px;
            object-fit: cover;
            background: #000;
        }

        .add-video-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            color: white;
            font-weight: 500;
        }
    </style>
    </head>

    <body>
        <%- include('partials/top-nav', { pageTitle: 'Viral Videos' , backButton: true, backUrl: '/' , actions: [ {
            id: 'addVideoBtn' , icon: 'fas fa-plus' , text: 'Add Video' , onClick: 'openAddVideoModal()' ,
            class: 'btn-primary' } ] }) %>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <%- include('partials/sidebar', { activePage: 'viral-videos' }) %>

                        <!-- Main Content -->
                        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="mainContent">
                            <div class="content-area">
                                <!-- Stats Cards -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card stats-card bg-primary text-white">
                                            <div class="card-body">
                                                <h5>Total Videos</h5>
                                                <h2 id="totalVideos">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card stats-card bg-success text-white">
                                            <div class="card-body">
                                                <h5>Active Videos</h5>
                                                <h2 id="activeVideos">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card stats-card bg-info text-white">
                                            <div class="card-body">
                                                <h5>Total Views</h5>
                                                <h2 id="totalViews">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Videos Grid -->
                                <div class="row" id="videosGrid">
                                    <div class="col-12 text-center py-5">
                                        <i class="fas fa-video fa-3x text-muted mb-3"></i>
                                        <h4 class="text-muted">No viral videos yet</h4>
                                        <p class="text-muted">Add your first viral video to get started</p>
                                        <button class="btn btn-primary" onclick="openAddVideoModal()">
                                            <i class="fas fa-plus me-2"></i>Add Video
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Add Video Modal -->
            <div class="modal fade" id="addVideoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Viral Video</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="videoForm">
                                <div class="mb-3">
                                    <label class="form-label">Title *</label>
                                    <input type="text" class="form-control" id="videoTitle" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="videoDescription" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Video Source</label>
                                    <div class="btn-group w-100 mb-2" role="group">
                                        <input type="radio" class="btn-check" name="videoSource" id="sourceUpload"
                                            value="upload" checked>
                                        <label class="btn btn-outline-primary" for="sourceUpload">
                                            <i class="fas fa-upload me-1"></i> Upload Video
                                        </label>
                                        <input type="radio" class="btn-check" name="videoSource" id="sourceUrl"
                                            value="url">
                                        <label class="btn btn-outline-primary" for="sourceUrl">
                                            <i class="fas fa-link me-1"></i> Video URL
                                        </label>
                                    </div>
                                </div>
                                <div id="uploadSection">
                                    <div class="mb-3">
                                        <label class="form-label">Upload Video File</label>
                                        <input type="file" class="form-control" id="videoFile" accept="video/*">
                                    </div>
                                </div>
                                <div id="urlSection" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">Video URL *</label>
                                        <input type="url" class="form-control" id="videoUrlInput"
                                            placeholder="https://youtube.com/shorts/... or Instagram/Vimeo URL">
                                        <small class="text-muted">Paste YouTube Shorts, Instagram Reels, or Vimeo
                                            URL</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="videoCategory">
                                        <option value="viral">Viral</option>
                                        <option value="trending">Trending</option>
                                        <option value="entertainment">Entertainment</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveVideo()">Save Video</button>
                        </div>
                    </div>
                </div>
            </div>

            <%- include('partials/footer') %>
                <script>
                    let currentVideoId = null;

                    document.addEventListener('DOMContentLoaded', function () {
                        setupMobileMenu();
                        loadVideos();

                        // Toggle between upload and URL
                        document.querySelectorAll('input[name="videoSource"]').forEach(radio => {
                            radio.addEventListener('change', function () {
                                if (this.value === 'upload') {
                                    document.getElementById('uploadSection').style.display = 'block';
                                    document.getElementById('urlSection').style.display = 'none';
                                } else {
                                    document.getElementById('uploadSection').style.display = 'none';
                                    document.getElementById('urlSection').style.display = 'block';
                                }
                            });
                        });
                    });

                    window.openAddVideoModal = function () {
                        currentVideoId = null;
                        document.getElementById('videoForm').reset();
                        document.querySelector('.modal-title').textContent = 'Add Viral Video';
                        document.getElementById('sourceUpload').checked = true;
                        document.getElementById('sourceUpload').dispatchEvent(new Event('change'));
                        new bootstrap.Modal(document.getElementById('addVideoModal')).show();
                    };

                    window.editVideo = function (video) {
                        currentVideoId = video._id;
                        document.querySelector('.modal-title').textContent = 'Edit Viral Video';

                        document.getElementById('videoTitle').value = video.title;
                        document.getElementById('videoDescription').value = video.content || '';
                        document.getElementById('videoCategory').value = video.category;

                        if (video.videoUrl) {
                            document.getElementById('sourceUrl').checked = true;
                            document.getElementById('videoUrlInput').value = video.videoUrl;
                            document.getElementById('sourceUrl').dispatchEvent(new Event('change'));
                        } else {
                            document.getElementById('sourceUpload').checked = true;
                            document.getElementById('sourceUpload').dispatchEvent(new Event('change'));
                        }

                        new bootstrap.Modal(document.getElementById('addVideoModal')).show();
                    };

                    window.saveVideo = async function () {
                        const title = document.getElementById('videoTitle').value;
                        const description = document.getElementById('videoDescription').value;
                        const category = document.getElementById('videoCategory').value;
                        const source = document.querySelector('input[name="videoSource"]:checked').value;

                        if (!title) {
                            alert('Please enter a title');
                            return;
                        }

                        try {
                            let mediaUrl = '';
                            let videoUrl = '';

                            if (source === 'url') {
                                videoUrl = document.getElementById('videoUrlInput').value;
                                if (!videoUrl) {
                                    alert('Please enter a video URL');
                                    return;
                                }
                            } else {
                                const fileInput = document.getElementById('videoFile');
                                if (!currentVideoId && !fileInput.files.length) {
                                    alert('Please select a video file');
                                    return;
                                }

                                if (fileInput.files.length > 0) {
                                    const formData = new FormData();
                                    formData.append('media', fileInput.files[0]);

                                    const uploadResponse = await fetch('/news/upload-media', {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (!uploadResponse.ok) throw new Error('Failed to upload video');
                                    const uploadData = await uploadResponse.json();
                                    mediaUrl = uploadData.mediaUrl;
                                }
                            }

                            const newsData = {
                                title,
                                content: description,
                                category,
                                mediaType: 'video',
                                ...(mediaUrl && { mediaUrl }),
                                ...(videoUrl && { videoUrl })
                            };

                            if (source === 'url') newsData.mediaUrl = '';
                            else newsData.videoUrl = '';

                            let url = '/viral-videos/api/videos';
                            let method = 'POST';

                            if (currentVideoId) {
                                url = `/viral-videos/api/videos/${currentVideoId}`;
                                method = 'PUT';
                            }

                            const response = await fetch(url, {
                                method: method,
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newsData)
                            });

                            if (response.ok) {
                                alert(currentVideoId ? 'Video updated successfully!' : 'Video added successfully!');
                                bootstrap.Modal.getInstance(document.getElementById('addVideoModal')).hide();
                                document.getElementById('videoForm').reset();
                                loadVideos();
                            } else {
                                const error = await response.json();
                                alert('Error saving video: ' + (error.error || 'Unknown error'));
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error: ' + error.message);
                        }
                    };

                    window.deleteVideo = async function (id) {
                        if (!confirm('Are you sure you want to delete this video?')) return;
                        try {
                            const response = await fetch(`/viral-videos/api/videos/${id}`, { method: 'DELETE' });
                            if (response.ok) loadVideos();
                            else {
                                const error = await response.json();
                                alert('Error: ' + (error.error || 'Unknown error'));
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error deleting video');
                        }
                    };

                    window.toggleVideoStatus = async function (id) {
                        try {
                            const response = await fetch(`/viral-videos/api/videos/${id}/toggle-status`, { method: 'PUT' });
                            if (response.ok) loadVideos();
                            else {
                                const error = await response.json();
                                alert('Error: ' + (error.error || 'Unknown error'));
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error toggling status');
                        }
                    };

                    function loadVideos() {
                        fetch('/viral-videos/api/videos')
                            .then(res => res.json())
                            .then(data => {
                                const videos = data.videos || [];
                                document.getElementById('totalVideos').textContent = videos.length;
                                document.getElementById('activeVideos').textContent = videos.filter(v => v.isActive).length;

                                const grid = document.getElementById('videosGrid');
                                if (videos.length === 0) {
                                    grid.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-video fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">No viral videos yet</h4>
                                <button class="btn btn-primary" onclick="openAddVideoModal()">Add Video</button>
                            </div>
                        `;
                                } else {
                                    grid.innerHTML = videos.map(video => {
                                        const statusBadge = video.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>';
                                        const statusBtn = video.isActive
                                            ? `<button class="btn btn-sm btn-outline-warning" onclick="toggleVideoStatus('${video._id}')"><i class="fas fa-ban"></i></button>`
                                            : `<button class="btn btn-sm btn-outline-success" onclick="toggleVideoStatus('${video._id}')"><i class="fas fa-check"></i></button>`;

                                        let videoEmbed = '';
                                        if (video.mediaUrl) videoEmbed = `<video class="video-preview" src="${video.mediaUrl}" controls></video>`;
                                        else if (video.videoUrl) videoEmbed = getVideoEmbed(video.videoUrl);

                                        const videoJson = JSON.stringify(video).replace(/'/g, "&#39;");

                                        return `
                                <div class="col-md-4">
                                    <div class="video-card card">
                                        ${videoEmbed}
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2">
                                                <h5 class="card-title text-truncate" style="max-width: 70%;">${video.title}</h5>
                                                ${statusBadge}
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mt-3">
                                                <span class="badge bg-primary">${video.category}</span>
                                                <div class="btn-group">
                                                    ${statusBtn}
                                                    <button class="btn btn-sm btn-outline-primary" onclick='editVideo(${videoJson})'><i class="fas fa-edit"></i></button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteVideo('${video._id}')"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                                    }).join('');
                                }
                            })
                            .catch(err => {
                                console.error('Error loading videos:', err);
                                document.getElementById('videosGrid').innerHTML = '<div class="col-12 text-center py-5"><h4 class="text-danger">Error loading videos</h4></div>';
                            });
                    }

                    function getVideoEmbed(url) {
                        if (url.includes('youtube.com/shorts/')) {
                            const videoId = url.split('shorts/')[1].split('?')[0];
                            return `<iframe class="video-preview" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                        }
                        if (url.includes('youtube.com/watch?v=') || url.includes('youtu.be/')) {
                            let videoId = url.includes('youtu.be/') ? url.split('youtu.be/')[1].split('?')[0] : url.split('v=')[1].split('&')[0];
                            return `<iframe class="video-preview" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                        }
                        if (url.includes('instagram.com/reel/')) return `<iframe class="video-preview" src="${url}embed/" frameborder="0" allowfullscreen></iframe>`;
                        if (url.includes('vimeo.com/')) {
                            const videoId = url.split('vimeo.com/')[1].split('?')[0];
                            return `<iframe class="video-preview" src="https://player.vimeo.com/video/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                        }
                        return `<div class="video-preview d-flex align-items-center justify-content-center bg-dark"><a href="${url}" target="_blank" class="text-white"><i class="fas fa-external-link-alt fa-3x"></i></a></div>`;
                    }

                    function setupMobileMenu() {
                        const menuToggle = document.getElementById('menuToggle');
                        const sidebar = document.getElementById('sidebar');
                        const mainContent = document.getElementById('mainContent');

                        if (menuToggle && sidebar) {
                            menuToggle.addEventListener('click', function (e) {
                                e.stopPropagation();
                                sidebar.classList.toggle('active');
                                mainContent.classList.toggle('sidebar-active');
                            });
                        }

                        document.addEventListener('click', function (event) {
                            if (window.innerWidth < 768 && sidebar && sidebar.classList.contains('active') && !sidebar.contains(event.target) && event.target !== menuToggle) {
                                sidebar.classList.remove('active');
                                if (mainContent) mainContent.classList.remove('sidebar-active');
                            }
                        });
                    }
                </script>
    </body>

</html>
</body>

</html>