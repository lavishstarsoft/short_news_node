<!DOCTYPE html>
<html lang="en">

<%- include('partials/header', { title: 'Reports Management' }) %>

    <style>
        /* Add any specific styles for reports page here */
        .stats-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .badge-status {
            font-size: 0.85em;
        }

        .btn-status {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .modal-content {
            border-radius: 10px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 767.98px) {
            .table-responsive {
                font-size: 0.875rem;
            }

            .btn-status {
                padding: 0.2rem 0.4rem;
                font-size: 0.75rem;
            }
        }
    </style>
    </head>

    <body>
        <%- include('partials/top-nav', { pageTitle: 'Reports Management' , backButton: true, backUrl: '/' }) %>
            </div>

            <div class="container-fluid">
                <div class="row">
                    <!-- Sidebar -->
                    <%- include('partials/sidebar', { activePage: 'reports' }) %>

                        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                            <div
                                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Reports Management</h1>
                                <div class="btn-toolbar mb-2 mb-md-0">
                                    <div class="btn-group me-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                            id="refreshReports">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Cards -->
                            <div class="row mb-4" id="reportStats">
                                <div class="col-md-3">
                                    <div class="card text-white bg-primary stats-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Total Reports</h5>
                                            <h2 class="card-text" id="totalReports">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-warning stats-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Pending</h5>
                                            <h2 class="card-text" id="pendingReports">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-info stats-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Reviewed</h5>
                                            <h2 class="card-text" id="reviewedReports">0</h2>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-white bg-success stats-card">
                                        <div class="card-body">
                                            <h5 class="card-title">Resolved</h5>
                                            <h2 class="card-text" id="resolvedReports">0</h2>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Navigation Tabs -->
                            <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="news-reports-tab" data-bs-toggle="tab"
                                        data-bs-target="#news-reports" type="button" role="tab"
                                        aria-controls="news-reports" aria-selected="true">
                                        <i class="fas fa-newspaper me-2"></i>News Reports
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="comment-reports-tab" data-bs-toggle="tab"
                                        data-bs-target="#comment-reports" type="button" role="tab"
                                        aria-controls="comment-reports" aria-selected="false">
                                        <i class="fas fa-comments me-2"></i>Comment Reports <span
                                            class="badge bg-danger ms-2" id="newCommentReportsBadge"
                                            style="display: none;">New</span>
                                    </button>
                                </li>
                            </ul>

                            <!-- Filter Controls -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Statuses</option>
                                        <option value="pending">Pending</option>
                                        <option value="reviewed">Reviewed</option>
                                        <option value="resolved">Resolved</option>
                                        <option value="dismissed">Dismissed</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control" id="searchInput"
                                        placeholder="Search reports...">
                                </div>
                            </div>

                            <!-- Tab Content -->
                            <div class="tab-content" id="reportTabsContent">
                                <!-- News Reports Tab -->
                                <div class="tab-pane fade show active" id="news-reports" role="tabpanel"
                                    aria-labelledby="news-reports-tab">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>News Title</th>
                                                            <th>Reporter</th>
                                                            <th>Reason</th>
                                                            <th>Description</th>
                                                            <th>Status</th>
                                                            <th>Created</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="reportsTableBody">
                                                        <!-- News Reports will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                            <nav>
                                                <ul class="pagination justify-content-center" id="pagination">
                                                    <!-- Pagination will be loaded here -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comment Reports Tab -->
                                <div class="tab-pane fade" id="comment-reports" role="tabpanel"
                                    aria-labelledby="comment-reports-tab">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Comment</th>
                                                            <th>News ID</th>
                                                            <th>Reporter</th>
                                                            <th>Reason</th>
                                                            <th>Details</th>
                                                            <th>Status</th>
                                                            <th>Created</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="commentReportsTableBody">
                                                        <tr>
                                                            <td colspan="8" class="text-center">Loading comment
                                                                reports...
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <nav>
                                                <ul class="pagination justify-content-center" id="commentPagination">
                                                    <!-- Pagination will be loaded here -->
                                                </ul>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </main>
                </div>
            </div>

            <!-- Update Status Modal -->
            <div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="updateStatusModalLabel">Update Report Status</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="reportId">
                            <input type="hidden" id="reportType" value="news"> <!-- 'news' or 'comment' -->
                            <div class="mb-3">
                                <label for="statusSelect" class="form-label">Status</label>
                                <select class="form-select" id="statusSelect">
                                    <option value="pending">Pending</option>
                                    <option value="reviewed">Reviewed</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="dismissed">Dismissed</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveStatusBtn">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Details Modal -->
            <div class="modal fade" id="newsDetailsModal" tabindex="-1" aria-labelledby="newsDetailsModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="newsDetailsModalLabel">News Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="newsLoading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="newsContent" style="display: none;">
                                <img id="newsImage" src="" alt="News Image" class="img-fluid rounded mb-3"
                                    style="width: 100%; max-height: 300px; object-fit: cover;">
                                <h4 id="newsTitle" class="mb-2"></h4>
                                <div class="d-flex gap-3 text-muted small mb-3">
                                    <span id="newsCategory" class="badge bg-secondary"></span>
                                    <span id="newsLocation"><i
                                            class="fas fa-map-marker-alt me-1"></i><span></span></span>
                                    <span id="newsDate"><i class="far fa-calendar-alt me-1"></i><span></span></span>
                                </div>
                                <p id="newsBody" class="lead"></p>
                            </div>
                            <div id="newsError" class="alert alert-danger" style="display: none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Details Modal -->
            <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="userLoading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="userContent" style="display: none;">
                                <div class="text-center mb-4">
                                    <img id="userProfilePic" src="/images/default-avatar.png" alt="Profile"
                                        class="rounded-circle mb-2"
                                        style="width: 100px; height: 100px; object-fit: cover;">
                                    <h4 id="userName" class="mb-0"></h4>
                                    <p id="userType" class="text-muted small"></p>
                                </div>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-envelope me-2 text-secondary"></i>Email</span>
                                        <span id="userEmail" class="fw-medium"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-phone me-2 text-secondary"></i>Phone</span>
                                        <span id="userPhone" class="fw-medium"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-calendar-alt me-2 text-secondary"></i>Joined Date</span>
                                        <span id="userJoined" class="fw-medium"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-id-badge me-2 text-secondary"></i>User ID</span>
                                        <span id="userIdDisplay" class="font-monospace small"></span>
                                    </li>
                                </ul>
                            </div>
                            <div id="userError" class="alert alert-danger" style="display: none;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Socket.io -->

            <!-- Bootstrap 5 JS Bundle with Popper -->
            <%- include('partials/footer') %>

                <script>
                    // Global variables
                    let currentPage = 1;
                    let commentCurrentPage = 1;
                    const reportsPerPage = 10;
                    let currentTab = 'news'; // 'news' or 'comment'

                    // We listen for custom events dispatched by sidebar.ejs
                    document.addEventListener('DOMContentLoaded', function () {
                        // Listen for new comment reports (from global sidebar listener)
                        document.addEventListener('new_comment_report_received', (e) => {
                            const data = e.detail;

                            // Show badge on tab if not active
                            if (currentTab !== 'comment') {
                                const badge = document.getElementById('newCommentReportsBadge');
                                if (badge) badge.style.display = 'inline-block';
                            }

                            // Reload comment reports if active
                            if (currentTab === 'comment') {
                                loadCommentReports(commentCurrentPage);
                                loadReportStats(); // Update stats
                            } else {
                                // Just update stats
                                loadReportStats();
                            }
                        });

                        // Listen for new news reports (from global sidebar listener)
                        document.addEventListener('new_news_report_received', (e) => {
                            const data = e.detail;

                            // Reload reports if active tab is news
                            if (currentTab === 'news') {
                                loadReports(currentPage);
                                loadReportStats(); // Update stats
                            } else {
                                // Just update stats if on other tab
                                loadReportStats();
                            }
                        });

                        // Load reports on page load
                        loadReports();
                        loadCommentReports();
                        loadReportStats();


                        // Event listeners
                        document.getElementById('refreshReports').addEventListener('click', () => {
                            if (currentTab === 'news') loadReports(currentPage);
                            else loadCommentReports(commentCurrentPage);
                            loadReportStats();
                        });

                        document.getElementById('statusFilter').addEventListener('change', () => {
                            if (currentTab === 'news') loadReports(1);
                            else loadCommentReports(1);
                        });

                        document.getElementById('searchInput').addEventListener('input', () => {
                            if (currentTab === 'news') loadReports(1);
                            else loadCommentReports(1);
                        });

                        document.getElementById('saveStatusBtn').addEventListener('click', updateReportStatus);

                        // Tab change listeners
                        const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
                        tabs.forEach(tab => {
                            tab.addEventListener('shown.bs.tab', function (event) {
                                if (event.target.id === 'comment-reports-tab') {
                                    currentTab = 'comment';
                                    document.getElementById('newCommentReportsBadge').style.display = 'none';
                                } else {
                                    currentTab = 'news';
                                }
                            });
                        });
                    });

                    // Load News reports
                    function loadReports(page = 1) {
                        currentPage = page;
                        const status = document.getElementById('statusFilter').value;
                        const search = document.getElementById('searchInput').value;

                        document.getElementById('reportsTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

                        const params = new URLSearchParams({ page: currentPage, limit: reportsPerPage });
                        if (status) params.append('status', status);
                        if (search) params.append('search', search);

                        fetch(`/reports?${params}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    renderReports(data.reports);
                                    renderPagination(data.pagination, 'pagination', loadReports);
                                } else {
                                    showError('Failed to load news reports: ' + data.message);
                                }
                            })
                            .catch(error => showError('Error loading news reports: ' + error.message));
                    }

                    // Load Comment Reports
                    function loadCommentReports(page = 1) {
                        commentCurrentPage = page;
                        const status = document.getElementById('statusFilter').value;
                        const search = document.getElementById('searchInput').value;

                        document.getElementById('commentReportsTableBody').innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';

                        const params = new URLSearchParams({ page: commentCurrentPage, limit: reportsPerPage });
                        if (status) params.append('status', status);
                        // Search implementation on backend for comments might be needed

                        fetch(`/reports/comments?${params}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    renderCommentReports(data.reports);
                                    renderPagination(data.pagination, 'commentPagination', loadCommentReports);
                                } else {
                                    showError('Failed to load comment reports: ' + data.message);
                                }
                            })
                            .catch(error => console.error('Error loading comment reports:', error));
                    }

                    // Render News reports
                    function renderReports(reports) {
                        const tbody = document.getElementById('reportsTableBody');
                        if (!reports || reports.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No reports found</td></tr>';
                            return;
                        }

                        tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>${report.newsId?.title || 'Unknown News'}</td>
                    <td>
                        ${report.userName}
                        <br>
                        <small class="text-muted">
                            ${report.userEmail ? (report.userEmail.match(/^\\d+$/) ? 'Mobile: ' + report.userEmail : 'Email: ' + report.userEmail) : 'No contact info'}
                        </small>
                    </td>
                    <td>${report.reason}</td>
                    <td>${report.description || 'No description provided'}</td>
                    <td><span class="badge bg-${getStatusBadgeClass(report.status)}">${report.status}</span></td>
                    <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openUpdateStatusModal('${report._id}', '${report.status}', 'news')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReport('${report._id}', 'news')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
                    }

                    // Show User Details Modal
                    window.showUserDetails = function (userId, type) {
                        console.log('showUserDetails called for:', userId, type);
                        if (!userId || userId === 'undefined') {
                            showToast('Error', 'Invalid User ID');
                            return;
                        }

                        const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                        const loading = document.getElementById('userLoading');
                        const content = document.getElementById('userContent');
                        const errorDiv = document.getElementById('userError');

                        // Reset modal state
                        document.getElementById('userDetailsModalLabel').textContent = type + ' Details';
                        document.getElementById('userType').textContent = type;
                        loading.style.display = 'block';
                        content.style.display = 'none';
                        errorDiv.style.display = 'none';

                        modal.show();

                        // Fetch user details
                        fetch(`/admin/users/${userId}`)
                            .then(response => {
                                if (!response.ok) throw new Error('Failed to fetch user details');
                                return response.json();
                            })
                            .then(user => {
                                // Populate modal
                                document.getElementById('userName').textContent = user.username || user.firstName + ' ' + user.lastName || 'Unknown Name';
                                document.getElementById('userEmail').textContent = user.email || 'Not provided';
                                document.getElementById('userPhone').textContent = user.phone || 'Not provided';
                                document.getElementById('userProfilePic').src = user.profilePic || '/images/default-avatar.png';
                                document.getElementById('userJoined').textContent = new Date(user.createdAt).toLocaleDateString();
                                document.getElementById('userIdDisplay').textContent = user._id;

                                // Show content
                                loading.style.display = 'none';
                                content.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Error fetching user details:', error);
                                loading.style.display = 'none';
                                errorDiv.textContent = 'Error loading details: ' + error.message;
                                errorDiv.style.display = 'block';
                            });
                    };

                    // Render Comment Reports
                    function renderCommentReports(reports) {
                        const tbody = document.getElementById('commentReportsTableBody');
                        if (!reports || reports.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No comment reports found</td></tr>';
                            return;
                        }

                        tbody.innerHTML = reports.map(report => `
                <tr>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                        <div title="${report.commentText}">"${report.commentText ? report.commentText.substring(0, 50) + (report.commentText.length > 50 ? '...' : '') : ''}"</div>
                        <small class="text-muted">By: <a href="javascript:void(0)" onclick="showUserDetails('${report.commentUserId}', 'Commenter')" class="text-decoration-none fw-bold">${report.commentUserName}</a></small>
                    </td>
                    <td>
                        <a href="javascript:void(0)" onclick="showNewsDetails('${report.newsId}')" class="text-decoration-none fw-bold text-primary">
                            ${report.newsId ? report.newsId.substring(0, 8) + '...' : 'Unknown'} <i class="fas fa-external-link-alt small ms-1"></i>
                        </a>
                    </td>
                    <td>
                        <a href="javascript:void(0)" onclick="showUserDetails('${report.reportedBy ? report.reportedBy.userId : ''}', 'Reporter')" class="text-decoration-none fw-bold text-dark">
                            ${report.reportedBy ? report.reportedBy.userName : 'Anonymous'}
                        </a>
                    </td>
                    <td><span class="badge bg-danger">${report.reason}</span></td>
                    <td>${report.additionalDetails || '-'}</td>
                    <td><span class="badge bg-${getStatusBadgeClass(report.status)}">${report.status}</span></td>
                    <td>${new Date(report.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary mb-1" onclick="openUpdateStatusModal('${report._id}', '${report.status}', 'comment')" title="Update Status">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger mb-1" onclick="deleteReport('${report._id}', 'comment')" title="Delete Report">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-warning text-dark mb-1" onclick="deleteCommentContent('${report._id}')" title="Delete User Comment">
                            <i class="fas fa-ban"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
                    }

                    // Show News Details Modal
                    window.showNewsDetails = function (newsId) {
                        console.log('showNewsDetails called with ID:', newsId);

                        if (!newsId || newsId === 'undefined' || newsId === 'null') {
                            console.error('Invalid News ID');
                            showToast('Error', 'Invalid News ID');
                            return;
                        }

                        const modalElement = document.getElementById('newsDetailsModal');
                        if (!modalElement) {
                            console.error('Modal element not found');
                            return;
                        }

                        const modal = new bootstrap.Modal(modalElement);
                        const loading = document.getElementById('newsLoading');
                        const content = document.getElementById('newsContent');
                        const errorDiv = document.getElementById('newsError');

                        // Reset modal state
                        loading.style.display = 'block';
                        content.style.display = 'none';
                        errorDiv.style.display = 'none';

                        modal.show();

                        // Fetch news details - Corrected path
                        fetch(`/news/api/news/${newsId}`)
                            .then(response => {
                                if (!response.ok) {
                                    if (response.status === 404) throw new Error('News article not found (it may have been deleted)');
                                    throw new Error('Failed to fetch news details (' + response.status + ')');
                                }
                                return response.json();
                            })
                            .then(news => {
                                // Populate modal
                                document.getElementById('newsTitle').textContent = news.title || 'No Title';
                                document.getElementById('newsImage').src = news.mediaUrl || news.imageUrl || '/images/placeholder.jpg';
                                document.getElementById('newsCategory').textContent = news.category || 'Uncategorized';

                                const locationSpan = document.getElementById('newsLocation').querySelector('span');
                                locationSpan.textContent = news.location || 'Unknown Location';

                                const dateSpan = document.getElementById('newsDate').querySelector('span');
                                dateSpan.textContent = new Date(news.publishedAt).toLocaleDateString();

                                document.getElementById('newsBody').textContent = news.content || 'No content available.';

                                // Show content
                                loading.style.display = 'none';
                                content.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Error fetching news details:', error);
                                loading.style.display = 'none';
                                errorDiv.textContent = 'Error loading news details: ' + error.message;
                                errorDiv.style.display = 'block';
                            });
                    }

                    // Get badge class
                    function getStatusBadgeClass(status) {
                        switch (status) {
                            case 'pending': return 'warning';
                            case 'reviewed': return 'info';
                            case 'resolved': return 'success';
                            case 'removed': return 'danger';
                            case 'dismissed': return 'secondary';
                            case 'ignored': return 'secondary';
                            default: return 'secondary';
                        }
                    }

                    // Render pagination
                    function renderPagination(pagination, elementId, callback) {
                        const paginationEl = document.getElementById(elementId);
                        if (!pagination || pagination.pages <= 1) {
                            paginationEl.innerHTML = '';
                            return;
                        }

                        let paginationHtml = '';

                        // Limit page buttons shown
                        const maxButtons = 5;
                        let startPage = Math.max(1, pagination.page - Math.floor(maxButtons / 2));
                        let endPage = Math.min(pagination.pages, startPage + maxButtons - 1);

                        if (endPage - startPage + 1 < maxButtons) {
                            startPage = Math.max(1, endPage - maxButtons + 1);
                        }

                        if (pagination.page > 1) {
                            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="${callback.name}(${pagination.page - 1}); return false;">Previous</a></li>`;
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            if (i === pagination.page) {
                                paginationHtml += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                            } else {
                                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="${callback.name}(${i}); return false;">${i}</a></li>`;
                            }
                        }

                        if (pagination.page < pagination.pages) {
                            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="${callback.name}(${pagination.page + 1}); return false;">Next</a></li>`;
                        }

                        paginationEl.innerHTML = paginationHtml;
                    }

                    // Open update status modal
                    function openUpdateStatusModal(reportId, currentStatus, type) {
                        document.getElementById('reportId').value = reportId;
                        document.getElementById('reportType').value = type;
                        document.getElementById('statusSelect').value = currentStatus;

                        // Add 'removed' and 'ignored' options for comments if not present
                        const statusSelect = document.getElementById('statusSelect');
                        // Reset options first
                        statusSelect.innerHTML = `
                <option value="pending">Pending</option>
                <option value="reviewed">Reviewed</option>
                <option value="resolved">Resolved</option>
                <option value="dismissed">Dismissed</option>
            `;

                        if (type === 'comment') {
                            statusSelect.innerHTML += `
                    <option value="removed">Removed</option>
                    <option value="ignored">Ignored</option>
                `;
                        }

                        statusSelect.value = currentStatus;

                        new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
                    }

                    // Update report status
                    function updateReportStatus() {
                        const reportId = document.getElementById('reportId').value;
                        const status = document.getElementById('statusSelect').value;
                        const type = document.getElementById('reportType').value;

                        const endpoint = type === 'comment'
                            ? `/reports/comments/${reportId}/status`
                            : `/reports/${reportId}/status`;

                        fetch(endpoint, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                                    showSuccess('Report status updated successfully');
                                    loadReportStats();
                                    if (type === 'news') loadReports(currentPage);
                                    else loadCommentReports(commentCurrentPage);
                                } else {
                                    showError('Failed to update report status: ' + data.message);
                                }
                            })
                            .catch(error => showError('Error updating report status: ' + error.message));
                    }

                    // Delete report
                    function deleteReport(reportId, type) {
                        if (confirm('Are you sure you want to delete this report record? (This does NOT delete the actual comment)')) {
                            const endpoint = type === 'comment'
                                ? `/reports/comments/${reportId}`
                                : `/reports/${reportId}`;

                            fetch(endpoint, { method: 'DELETE' })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        showToast('Success', 'Report deleted successfully');
                                        loadReportStats();
                                        if (type === 'news') loadReports(currentPage);
                                        else loadCommentReports(commentCurrentPage);
                                    } else {
                                        showError('Failed to delete report: ' + data.message);
                                    }
                                })
                                .catch(error => showError('Error deleting report: ' + error.message));
                        }
                    }

                    // Delete actual comment content
                    function deleteCommentContent(reportId) {
                        if (confirm('WARNING: Are you sure you want to delete the USER COMMENT from the app? This cannot be undone.')) {
                            fetch(`/reports/comments/${reportId}/content`, {
                                method: 'DELETE'
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        showToast('Success', 'Comment deleted from app successfully');
                                        loadReportStats();
                                        loadCommentReports(commentCurrentPage);
                                    } else {
                                        showError('Failed to delete comment: ' + data.message);
                                    }
                                })
                                .catch(error => showError('Error deleting comment: ' + error.message));
                        }
                    }

                    // Load report statistics
                    function loadReportStats() {
                        fetch('/reports/stats')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    document.getElementById('totalReports').textContent = data.stats.total || 0;
                                    document.getElementById('pendingReports').textContent = data.stats.pending || 0;
                                    document.getElementById('reviewedReports').textContent = data.stats.reviewed || 0;
                                    const resolved = (data.stats.resolved || 0) + (data.stats.removed || 0) + (data.stats.ignored || 0);
                                    document.getElementById('resolvedReports').textContent = resolved;
                                }
                            })
                            .catch(error => console.error('Error loading report stats:', error));
                    }

                    function showError(message) { alert('Error: ' + message); }
                    function showSuccess(message) { alert('Success: ' + message); }
                </script>
    </body>

</html>